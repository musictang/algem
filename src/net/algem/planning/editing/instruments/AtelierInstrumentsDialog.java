package net.algem.planning.editing.instruments;

import net.algem.config.Instrument;
import net.algem.contact.Person;
import net.algem.planning.editing.instruments.AtelierInstrumentsService.PersonInstrumentRow;
import net.algem.util.BundleUtil;
import net.algem.util.GemLogger;

import javax.swing.*;
import javax.swing.table.AbstractTableModel;
import java.awt.*;
import java.awt.event.*;
import java.sql.SQLException;
import java.util.List;

public class AtelierInstrumentsDialog extends JDialog {

    {
// GUI initializer generated by IntelliJ IDEA GUI Designer
// >>> IMPORTANT!! <<<
// DO NOT EDIT OR ADD ANY CODE HERE!
        $$$setupUI$$$();
    }

    /**
     * Method generated by IntelliJ IDEA GUI Designer
     * >>> IMPORTANT!! <<<
     * DO NOT edit this method OR call it in your code!
     *
     * @noinspection ALL
     */
    private void $$$setupUI$$$() {
        contentPane = new JPanel();
        contentPane.setLayout(new GridBagLayout());
        contentPane.setMinimumSize(new Dimension(300, 300));
        contentPane.setPreferredSize(new Dimension(300, 200));
        final JPanel panel1 = new JPanel();
        panel1.setLayout(new GridBagLayout());
        panel1.setAlignmentX(0.5f);
        panel1.putClientProperty("html.disable", Boolean.FALSE);
        GridBagConstraints gbc;
        gbc = new GridBagConstraints();
        gbc.gridx = 0;
        gbc.gridy = 1;
        gbc.weightx = 1.0;
        gbc.anchor = GridBagConstraints.EAST;
        gbc.fill = GridBagConstraints.VERTICAL;
        contentPane.add(panel1, gbc);
        final JPanel panel2 = new JPanel();
        panel2.setLayout(new FlowLayout(FlowLayout.CENTER, 5, 5));
        panel2.setAlignmentX(0.5f);
        gbc = new GridBagConstraints();
        gbc.gridx = 1;
        gbc.gridy = 0;
        gbc.weighty = 1.0;
        gbc.fill = GridBagConstraints.BOTH;
        panel1.add(panel2, gbc);
        buttonOK = new JButton();
        buttonOK.setText("OK");
        panel2.add(buttonOK);
        buttonCancel = new JButton();
        buttonCancel.setText("Cancel");
        panel2.add(buttonCancel);
        final JPanel panel3 = new JPanel();
        panel3.setLayout(new GridBagLayout());
        panel3.setMinimumSize(new Dimension(300, 200));
        gbc = new GridBagConstraints();
        gbc.gridx = 0;
        gbc.gridy = 0;
        gbc.weightx = 1.0;
        gbc.weighty = 1.0;
        gbc.fill = GridBagConstraints.BOTH;
        contentPane.add(panel3, gbc);
        table1 = new JTable();
        gbc = new GridBagConstraints();
        gbc.gridx = 0;
        gbc.gridy = 0;
        gbc.weightx = 1.0;
        gbc.weighty = 1.0;
        gbc.fill = GridBagConstraints.BOTH;
        panel3.add(table1, gbc);
    }

    /**
     * @noinspection ALL
     */
    public JComponent $$$getRootComponent$$$() {
        return contentPane;
    }

    interface Callback {
        void onOkSelected(List<PersonInstrumentRow> rows);
    }

    private JPanel contentPane;
    private JButton buttonOK;
    private JButton buttonCancel;
    private JTable table1;

    private TableModel tableModel;
    private AtelierInstrumentsService instrumentsService;
    private Callback callback;

    static class TableModel extends AbstractTableModel {
        final List<PersonInstrumentRow> rows;

        public List<PersonInstrumentRow> getRows() {
            return rows;
        }

        TableModel(List<PersonInstrumentRow> rows) {
            this.rows = rows;
        }

        @Override
        public int getRowCount() {
            return rows.size();
        }

        @Override
        public int getColumnCount() {
            return 2;
        }

        @Override
        public boolean isCellEditable(int rowIndex, int columnIndex) {
            return columnIndex == 1;
        }

        @Override
        public Object getValueAt(int rowIndex, int columnIndex) {
            PersonInstrumentRow row = rows.get(rowIndex);
            switch (columnIndex) {
                case 0:
                    return row.person;
                case 1:
                    return row.instrument;
            }
            return row;
        }

        @Override
        public void setValueAt(Object aValue, int rowIndex, int columnIndex) {
            System.out.println("TableModel.setValueAt");
            System.out.println("aValue = [" + aValue + "], rowIndex = [" + rowIndex + "], columnIndex = [" + columnIndex + "]");
            if (columnIndex == 1) {
                PersonInstrumentRow row = rows.get(rowIndex);
                row.instrument = (Instrument) aValue;
            }
        }
    }

    class InstrumentCellEditor extends DefaultCellEditor {
        public InstrumentCellEditor() {
            super(new JComboBox<Instrument>());
        }

        @SuppressWarnings("unchecked")
        @Override
        public Component getTableCellEditorComponent(JTable table, Object value, boolean isSelected, int row, int column) {
            JComboBox<Instrument> component = (JComboBox<Instrument>) super.getTableCellEditorComponent(table, value, isSelected, row, column);
            Person person = (Person) table.getModel().getValueAt(row, 0);
            List<Instrument> availableInstruments = null;
            try {
                availableInstruments = instrumentsService.getAvailableInstruments(person);
                DefaultComboBoxModel<Instrument> aModel = new DefaultComboBoxModel<>();

                aModel.addElement(null);
                for (Instrument availableInstrument : availableInstruments) {
                    aModel.addElement(availableInstrument);
                }
                component.setModel(aModel);
                component.setSelectedItem(table.getModel().getValueAt(row, 1));
            } catch (Exception e) {
                GemLogger.logException(e);
            }
            return component;
        }
    }

    public AtelierInstrumentsDialog(AtelierInstrumentsService instrumentsService, Callback callback) {
        this.instrumentsService = instrumentsService;
        this.callback = callback;
        setContentPane(contentPane);
        setModal(true);
        getRootPane().setDefaultButton(buttonOK);

        buttonOK.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                onOK();
            }
        });

        buttonCancel.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                onCancel();
            }
        });

// call onCancel() when cross is clicked
        setDefaultCloseOperation(DO_NOTHING_ON_CLOSE);
        addWindowListener(new WindowAdapter() {
            public void windowClosing(WindowEvent e) {
                onCancel();
            }
        });

// call onCancel() on ESCAPE
        contentPane.registerKeyboardAction(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                onCancel();
            }
        }, KeyStroke.getKeyStroke(KeyEvent.VK_ESCAPE, 0), JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);

        setTitle(BundleUtil.getLabel("course.instruments.label"));
    }

    public void setData(List<PersonInstrumentRow> data) {
        this.tableModel = new TableModel(data);
        table1.setModel(tableModel);
        table1.getColumnModel().getColumn(1).setCellEditor(new InstrumentCellEditor());
    }

    private void onOK() {
        callback.onOkSelected(tableModel.getRows());
        dispose();
    }

    private void onCancel() {
// add your code here if necessary
        dispose();
    }

}
